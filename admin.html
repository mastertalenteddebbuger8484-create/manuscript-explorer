<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - Manuscript Explorer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Georgia', serif; overflow-x: hidden; color: #1a1510; }
        .login-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .hidden { display: none !important; }
        .admin-container { max-width: 1200px; margin: auto; }
        .card-header { background: #3a2f0b; color: #ffeb3b; }
        .img-thumb { width: 50px; height: 70px; object-fit: cover; }
        .desc-cell { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .generate-btn { margin-top: 5px; background: #ffeb3b; color: #1a1510; font-weight: bold; border: none; }
        input, select, textarea { background: rgba(255,255,255,0.1); color: #1a1510; border: 2px solid #ffeb3b; }
        input::placeholder, textarea::placeholder { color: #666; }
        select { color: #1a1510; }

        /* --- LIVE YELLOW BACKGROUND --- */
        .live-bg {
            position: fixed; top:0; left:0; width:100%; height:100%; z-index:-1;
            background: radial-gradient(circle at center, #fff9c4 0%, #3a2f0b 100%);
            overflow: hidden;
        }
        .particle {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 235, 59, 0.5);
            animation: float 25s infinite linear;
        }
        @keyframes float {
            0% { transform: translateY(0) translateX(0); opacity: 0; }
            50% { opacity: 0.8; }
            100% { transform: translateY(-100vh) translateX(50px); opacity: 0; }
        }
    </style>
</head>
<body>

<div class="live-bg" id="bgEffect"></div>

<div id="loginScreen" class="login-overlay">
    <div class="card p-4 text-center" style="background: #3a2f0b; border: 2px solid #ffeb3b;">
        <h3 style="color:#ffeb3b;">Developer Login</h3>
        <input type="password" id="password" class="form-control mt-3" placeholder="Enter Password">
        <button class="btn btn-warning mt-3 w-100" onclick="checkLogin()">Login</button>
        <small class="text-muted mt-2 d-block" style="color:#fff;">Pass: admin123</small>
    </div>
</div>

<div class="admin-container hidden" id="dashboard">
    <h2 class="mb-4" style="color:#3a2f0b;">Manuscript Management</h2>
    <a href="/" class="btn btn-outline-dark mb-4">← Back to Home</a>

    <div class="card mb-5">
        <div class="card-header" id="formHeader">Add New Manuscript</div>
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data" id="manuscriptForm">
                <input type="hidden" name="add_manuscript" id="actionInput" value="1">
                <input type="hidden" name="id" id="manuscriptId">
                
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label>Title</label>
                        <input type="text" name="title" id="title" class="form-control" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label>Era</label>
                        <select name="era" id="era" class="form-select" required>
                            <option value="" disabled selected>Select Era</option>
                            <option>Vedic Period (c. 1500–500 BCE)</option>
                            <option>Mauryan Empire (322–185 BCE)</option>
                            <option>Gupta Era (c. 319–543 CE)</option>
                            <option>Medieval Period (600–1500 CE)</option>
                            <option>Mughal Era (1526–1857 CE)</option>
                            <option>British Raj (1858–1947 CE)</option>
                            <option>Modern Era</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label>Genre</label>
                        <select name="genre" id="genre" class="form-select" required>
                            <option value="" disabled selected>Select Genre</option>
                            <option>Vedas & Upanishads</option>
                            <option>Ayurveda & Medicine</option>
                            <option>Jyotisha (Astrology)</option>
                            <option>Epics (Ramayana/Mahabharata)</option>
                            <option>Dharmashastra (Law)</option>
                            <option>Literature & Poetry</option>
                            <option>History</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label>Description</label>
                    <textarea name="description" id="description" class="form-control" rows="3" required></textarea>
                    <button type="button" class="btn generate-btn" id="generateBtn" onclick="generateDescription()">Auto Generate Summary with AI</button>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Cover Image (Leave empty to keep current if editing)</label>
                        <input type="file" name="cover" id="cover" class="form-control" accept="image/*">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>PDF File (Leave empty to keep current if editing)</label>
                        <input type="file" name="pdf" id="pdf" class="form-control" accept="application/pdf">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" id="submitBtn">Submit Manuscript</button>
                <button type="button" class="btn btn-secondary hidden" id="cancelBtn" onclick="resetForm()">Cancel Edit</button>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Database</div>
        <div class="card-body">
            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th>Cover</th>
                        <th>Title</th>
                        <th>Era</th>
                        <th>Genre</th>
                        <th>Description</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for m in manuscripts %}
                    <tr>
                        <td><img src="{{ url_for('static', filename='uploads/' + m['cover_image']) }}" class="img-thumb"></td>
                        <td>{{ m['title'] }}</td>
                        <td>{{ m['era'] }}</td>
                        <td>{{ m['genre'] }}</td>
                        <td class="desc-cell" title="{{ m['description'] }}">{{ m['description'] }}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" 
                                onclick='loadEditData({{ m["id"] }}, "{{ m["title"] }}", "{{ m["era"] }}", "{{ m["genre"] }}", {{ m["description"] | tojson }})'>
                                Edit
                            </button>
                            <form method="POST" style="display:inline-block;">
                                <input type="hidden" name="delete_manuscript" value="1">
                                <input type="hidden" name="id" value="{{ m['id'] }}">
                                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Particle background
    const bg = document.getElementById('bgEffect');
    for(let i=0;i<30;i++){
        let p=document.createElement('div');
        p.className='particle';
        p.style.width=Math.random()*8+'px';
        p.style.height=p.style.width;
        p.style.left=Math.random()*100+'vw';
        p.style.top=Math.random()*100+'vh';
        p.style.animationDuration=(Math.random()*15+10)+'s';
        bg.appendChild(p);
    }

    function checkLogin() {
        if(document.getElementById('password').value==="admin123"){
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        } else { alert("Wrong password!"); }
    }

    function loadEditData(id,title,era,genre,description){
        document.getElementById('formHeader').innerText="Edit Manuscript ID: "+id;
        document.getElementById('actionInput').name="edit_manuscript";
        document.getElementById('manuscriptId').value=id;
        document.getElementById('title').value=title;
        document.getElementById('era').value=era;
        document.getElementById('genre').value=genre;
        document.getElementById('description').value=description;
        document.getElementById('cover').required=false;
        document.getElementById('pdf').required=false;
        document.getElementById('submitBtn').innerText="Update Manuscript";
        document.getElementById('submitBtn').classList.replace('btn-primary','btn-warning');
        document.getElementById('cancelBtn').classList.remove('hidden');
        window.scrollTo(0,0);
    }

    function resetForm(){
        document.getElementById('formHeader').innerText="Add New Manuscript";
        document.getElementById('actionInput').name="add_manuscript";
        document.getElementById('manuscriptForm').reset();
        document.getElementById('cover').required=true;
        document.getElementById('pdf').required=true;
        document.getElementById('submitBtn').innerText="Submit Manuscript";
        document.getElementById('submitBtn').classList.replace('btn-warning','btn-primary');
        document.getElementById('cancelBtn').classList.add('hidden');
    }

    // ===== GEMINI API INTEGRATION =====
    const GEMINI_API_KEY = "AIzaSyC7VTFChnTWIhvZrC3POEcGTrTtbLFRBPE"; // <-- Put your API key here

    async function generateDescription() {
        const title = document.getElementById('title').value.trim();
        const era = document.getElementById('era').value;
        const genre = document.getElementById('genre').value;

        if (!title || !era || !genre) {
            alert("Please fill Title, Era, and Genre before generating description.");
            return;
        }

        const descBox = document.getElementById('description');
        const btn = document.getElementById('generateBtn');
        btn.disabled = true;
        btn.innerText = "Generating...";

        try {
            const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${GEMINI_API_KEY}`
                },
                body: JSON.stringify({
                    model: "gemini-1.5",
                    input: `Write a detailed manuscript description for a manuscript with Title: "${title}", Era: "${era}", Genre: "${genre}".`,
                    temperature: 0.7
                })
            });

            const data = await response.json();
            if (data?.output_text) {
                descBox.value = data.output_text;
            } else if (data?.output && data.output.length > 0 && data.output[0].content && data.output[0].content[0].text) {
                descBox.value = data.output[0].content[0].text;
            } else {
                descBox.value = "No summary generated.";
            }
        } catch (e) {
            console.error(e);
            alert("Error generating summary. Check your API key or network.");
            descBox.value = "";
        }

        btn.disabled = false;
        btn.innerText = "Auto Generate Summary with AI";
    }
</script>
</body>
</html>
